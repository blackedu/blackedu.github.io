# 马尔科夫链
最早看到马尔科夫链是我大三时候参加数学建模的时候。当时觉得这个模型很复杂，很多预测模型都比较容易理解，唯独这个模型概念多，真不知道哪来做什么？直到工作以后，深入学习自然语言处理（NLP）时，发现隐马尔科夫链的原来这么强悍，竟然可以用于分词。除此之外很多地方都使用了这个模型。
马尔科夫链分为显马尔科夫链和隐马尔科夫链。显马尔科夫链相对简单，本文先介绍这种模型。
![AAMarkov -w300](media/15280243265316/AAMarkov.jpg)


## 马尔科夫介绍
安德烈·马尔可夫，俄罗斯人，物理-数学博士，圣彼得堡科学院院士，彼得堡数学学派的代表人物，以数论和概率论方面的工作著称，他的主要著作有《概率演算》等。1878年，荣获金质奖章，1905年被授予功勋教授称号。马尔可夫是彼得堡数学学派的代表人物。在数论方面，他研究了连分数和二次不定式理论，解决了许多难题。在概率论中，他发展了矩阵法，扩大了大数律和中心极限定理的应用范围。

马尔可夫最重要的工作是在1906～1912年间，提出并研究了一种能用数学分析方法研究自然过程的一般图式——马尔可夫链。同时开创了对一种无后效性的随机过程——马尔可夫过程的研究。

马尔可夫经多次观察试验发现，一个系统的状态转换过程中第n次转换获得的状态常取决于前一次（第（n-1）次）试验的结果。马尔可夫进行深入研究后指出：对于一个系统，由一个状态转至另一个状态的转换过程中，存在着转移概率，并且这种转移概率可以依据其紧接的前一种状态推算出来，与该系统的原始状态和此次转移前的马尔可夫过程无关。马尔可夫链理论与方法在现代已经被广泛应用于自然科学、工程技术和公用事业中。

## 问题提出
先来看这样一个天气预测的问题。我们把天气大致分为三中情况，晴天（Sunny）、雨天（Rainy）和多云（Cloudy）天气。
![马尔科夫_天气预测图](media/15280243265316/%E9%A9%AC%E5%B0%94%E7%A7%91%E5%A4%AB_%E5%A4%A9%E6%B0%94%E9%A2%84%E6%B5%8B%E5%9B%BE.jpg)

上图是三种天气的转换概率图，晴天转为晴天的概率为0.6，晴天转为多云的概率为0.3，晴天转为雨天的概率为0.1，一次类推得到如下的概率表：

| | 晴天 | 多云 | 下雨 |
| --- | --- | --- | --- |
| 晴天 | 0.6 | 0.3 | 0.1 |
| 多云 | 0.2 | 0.3 | 0.5 |
| 雨天 | 0.4 | 0.1 | 0.5 |
加入本月的第1天的是晴天，那么请预测第3天的天气？以及本月底10天的天气？
对于这样的天气预测问题，其实就是简单的概率相乘问题，我们分析已知了第一天天气以及每种天气转化的概率，至于要以此类推即可，于是我们记第n天的天气状态为
$$
\vec d_n= (S_n，C_n，R_n)
$$
其中Sn、Cn和Rn分别为第n天晴天、多云和雨天的概率
$$
\begin{align}
\vec d_1 &= (1,0,0) \\
\vec d_2 &= (0.6, 0.3, 0.1)
\end{align}
$$

$$
\begin{align}
S_3 &= p(晴天转晴天) + p(多云转晴天) + p(雨天转晴天) \\
    &= 0.6 \times 0.6 + 0.3 \times 0.2 + 0.1 \times 0.4 \\
    &=0.46 \\
C_3 &=p(晴天转多云) + p(多云转多云) + p(雨天转多云) \\
    &= 0.6 \times 0.3 + 0.3 \times 0.3 + 0.1 \times 0.1  \\
    &=0.28 \\
R_3 &=p(晴天转雨天) + p(阴天转雨天) + p(雨天转雨天)  \\
    &=0.6 \times 0.1 + 0.3 \times 0.5 + 0.1 \times 0.5 \\
    &=0.26 \\
\vec d_3 &= (S_3, C_3, R_3) = (0.46, 0.28,0.26)
\end{align}
$$
于是得到了第三天的天气晴天、阴天和雨天的概率分别是0.46，0.28和0.26，由此可以类推出第10天的天气概率。

## 马尔科夫链
对于上述问题，已经使用了马尔科夫链，其中晴天、阴天和雨天称为天气的三种状态，而天气之间的转化概率称为状态的转移矩阵。在计算第三天天气时，只使用了第二天的天气状态，一般对于这种情况，当前状态只与上一个时序状态有关的称为齐次时序的马尔科夫链。
用数学语言表达就是：
$$
p(x_n|x_{n-1}, x_{n-2},\cdots,x_1) = p(x_n|x_{n-1})
$$
其中xn表示第n个时刻的状态，那么第n个时刻的状态概率只与上一个时刻有关，状态之间的转移矩阵用P来表示。

## 再看天气预测问题
对于上面天气预测问题，初始状态为：
$$
\vec d_1 = (1, 0, 0)
$$
于是转移矩阵为：
$$
\begin{equation}
\vec P = \left(
\begin{matrix}
   0.6 & 0.3 & 0.1 \\
   0.2 & 0.3 & 0.5 \\
   0.4 & 0.1 & 0.5
\end{matrix} \right)
\end{equation}
$$
第2天的状态为：
$$
\begin{equation}
\vec d_2 = \vec d_1 \vec P =
(1, 0, 0)\left(
\begin{matrix}
   0.6 & 0.3 & 0.1 \\
   0.2 & 0.3 & 0.5 \\
   0.4 & 0.1 & 0.5
\end{matrix} \right)
= (0.6, 0.3, 0.1)
\end{equation}
$$
第3天的状态为：
$$
\begin{equation}
\vec d_3 = \vec d_2 \vec P =
(0.6, 0.3, 0.1)\left(
\begin{matrix}
   0.6 & 0.3 & 0.1 \\
   0.2 & 0.3 & 0.5 \\
   0.4 & 0.1 & 0.5
\end{matrix} \right)
= (0.46,0.28,0.26)
\end{equation}
$$

Python编程求解，使用迭代的思想得到以下程序：

```python
import numpy as np

p = np.matrix(
    [
        [0.6, 0.3, 0.1],
        [0.2, 0.3, 0.5],
        [0.4, 0.1, 0.5]
    ]
)

d1 = np.matrix([1, 0, 0])

for i in range(100):
    d2 = d1 * p
    print("loop", i, "误差", np.sum(d2 - d1), "d=", d1)
    d1 = d2
```
输出结果为：

```
loop 0 误差 -2.77555756156e-17 d= [[1 0 0]]
loop 1 误差 -2.77555756156e-17 d= [[ 0.6  0.3  0.1]]
loop 2 误差 2.77555756156e-17 d= [[ 0.46  0.28  0.26]]
loop 3 误差 0.0 d= [[ 0.436  0.248  0.316]]
loop 4 误差 2.77555756156e-17 d= [[ 0.4376  0.2368  0.3256]]
loop 5 误差 5.55111512313e-17 d= [[ 0.44016  0.23488  0.32496]]
loop 6 误差 0.0 d= [[ 0.441056  0.235008  0.323936]]
loop 7 误差 5.55111512313e-17 d= [[ 0.4412096  0.2352128  0.3235776]]
loop 8 误差 -5.55111512313e-17 d= [[ 0.44119936  0.23528448  0.32351616]]
loop 9 误差 2.77555756156e-17 d= [[ 0.44118298  0.23529677  0.32352026]]
loop 10 误差 -2.77555756156e-17 d= [[ 0.44117724  0.23529595  0.32352681]]
......
loop 24 误差 2.77555756156e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 25 误差 2.77555756156e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 26 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 27 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 28 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 29 误差 2.77555756156e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 30 误差 5.55111512313e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 31 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 32 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
```
可以看到第10天天气的状态。但是在迭代中发现，大概经过30次迭代以后，结果稳定输出，也就是天气的状态收敛到一个固定值（0.44117647,0.23529412,0.32352941），通过改变初始状态的值，发现最终依然收敛到相同的天气状态。
初始值为（0.4,0.3,0.3）输出结果为：

```
oop 25 误差 -5.55111512313e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 26 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 27 误差 -5.55111512313e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 28 误差 -2.77555756156e-17 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 29 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 30 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
loop 31 误差 0.0 d= [[ 0.44117647  0.23529412  0.32352941]]
```
也就是说存在一个矩阵A,使得AP=A成立，也就是说无论什么样的初始状态，对于天气预测来说，大概一个月之后，天气的状态是(0.44117647,0.23529412,0.32352941)。得到这样的一个结论其实挺有意思的，很明显天气变化状态不可能是固定值，那我们再来分析一下马尔科夫链的特点：

1. 非周期性。由于最终是收敛到固定值，因此整个状态的循环是非周期的；
2. 任意两个状态是连通的。明显从一个状态经过有限时刻肯定能达到另一个状态；
3. 状态数是有限的。对于给定初值的状态，经过有限个状态以后收敛到稳定态；
4. 矩阵A称为马尔科夫的平衡分布。

## 总结
由于模型假定了下一个状态只与上一个时刻状态有关，也就是今天的天气只与昨天的天气有关，并且任何时刻天气的状态转移矩阵都是固定的。这两个假设有利于简化问题，但最终却得到一个与实际相差较远的结果。要使得模型能够更加准确的预测天气，需要改进这两基本假设。

